name: STEP Spatial Metadata Processor

on:
Â  push:
Â  Â  branches:
Â  Â  Â  - "**"
Â  workflow_dispatch:

jobs:
Â  code_quality_check:
Â  Â  runs-on: ubuntu-latest
Â  Â  steps:
Â  Â  Â  - name: ğŸ›ï¸ Checkout repository
Â  Â  Â  Â  uses: actions/checkout@v3

Â  Â  Â  - name: ğŸ Set up Python
Â  Â  Â  Â  uses: actions/setup-python@v4
Â  Â  Â  Â  with:
Â  Â  Â  Â  Â  python-version: '3.11'

Â  Â  Â  - name: ğŸ Install Python dependencies
Â  Â  Â  Â  run: |
Â  Â  Â  Â  Â  python -m pip install --upgrade pip
Â  Â  Â  Â  Â  pip install -r requirements.txt

Â  Â  Â  - name: ğŸ§¹ Run autoflake to remove unused imports
Â  Â  Â  Â  run: |
Â  Â  Â  Â  Â  autoflake --in-place --recursive --remove-unused-variables --remove-all-unused-imports .
Â  Â  Â  Â  Â Â 
Â  Â  Â  - name: ğŸ’€ Run vulture to find dead code
Â  Â  Â  Â  run: |
Â  Â  Â  Â  Â  vulture --exclude .github,tests,data .
Â  Â  Â  Â  Â Â 
Â  Â  Â  - name: ğŸš€ Commit autoflake changes
Â  Â  Â  Â  env:
Â  Â  Â  Â  Â  GIT_USER_NAME: ${{ secrets.GIT_USER_NAME }}
Â  Â  Â  Â  Â  GIT_USER_EMAIL: ${{ secrets.GIT_USER_EMAIL }}
Â  Â  Â  Â  run: |
Â  Â  Â  Â  Â  git config --global user.name "${GIT_USER_NAME}"
Â  Â  Â  Â  Â  git config --global user.email "${GIT_USER_EMAIL}"
Â  Â  Â  Â  Â  git add .
Â  Â  Â  Â  Â  git commit -m "ğŸ§¹ Auto-clean: removed unused imports and variables" || echo "No changes to commit"
Â  Â  Â  Â  Â  git push || echo "No changes to push"

Â  process_step_for_coordinates:
Â  Â  needs: code_quality_check
Â  Â  runs-on: ubuntu-latest
Â  Â  env:
Â  Â  Â  PYTHONPATH: ${{ github.workspace }}
Â  Â  Â  ENABLE_RULE_DEBUG: true

Â  Â  steps:
Â  Â  Â  - name: ğŸ›ï¸ Checkout repository
Â  Â  Â  Â  uses: actions/checkout@v3
Â  Â  Â  Â  with:
Â  Â  Â  Â  Â  # Token is needed for the final commit/push of logs/error reports
Â  Â  Â  Â  Â  token: ${{ secrets.GITHUB_TOKEN }}

Â  Â  Â  - name: ğŸ Set up Python
Â  Â  Â  Â  uses: actions/setup-python@v4
Â  Â  Â  Â  with:
Â  Â  Â  Â  Â  python-version: '3.11'

Â  Â  Â  - name: ğŸ§± Install system dependencies & Gmsh
Â  Â  Â  Â  run: |
Â  Â  Â  Â  Â  sudo apt-get update
Â  Â  Â  Â  Â  sudo apt-get install -y \
Â  Â  Â  Â  Â  Â  libglu1-mesa-dev \
Â  Â  Â  Â  Â  Â  libfreetype6-dev \
Â  Â  Â  Â  Â  Â  libfontconfig1-dev \
Â  Â  Â  Â  Â  Â  libxrender1 \
Â  Â  Â  Â  Â  Â  gmsh

Â  Â  Â  - name: ğŸ Install Python dependencies
Â  Â  Â  Â  run: |
Â  Â  Â  Â  Â  python -m pip install --upgrade pip
Â  Â  Â  Â  Â  pip install -r requirements.txt

Â  Â  Â  - name: âœ… Confirm Gmsh & Python bindings
Â  Â  Â  Â  run: |
Â  Â  Â  Â  Â  gmsh -version || { echo "âŒ Gmsh CLI not found"; exit 1; }
Â  Â  Â  Â  Â  python -c "import gmsh; gmsh.initialize(); gmsh.finalize(); print('âœ… Gmsh Python bindings operational')" || { echo "âŒ Gmsh Python bindings failed"; exit 1; }
Â  Â  Â  Â  Â Â 
Â  Â  Â  # ----------------------------------------------------------------------
Â  Â  Â  # Integration Test 1: test_cube (HARD FAIL on mismatch)
Â  Â  Â  # ----------------------------------------------------------------------
Â  Â  Â  - name: ğŸƒ Run Integration Test (test_cube)
Â  Â  Â  Â  id: integration_test_cube
Â  Â  Â  Â  # Failure here stops the workflow.
Â  Â  Â  Â  run: |
Â  Â  Â  Â  Â  STEP_FILE="tests/test_models/test_cube.step"
Â  Â  Â  Â  Â  EXPECTED_OUTPUT_PATH="tests/test_models/test_cube_output.json"
Â  Â  Â  Â  Â  TEMP_OUTPUT_FILE="tests/test_models/test_cube_cli_output.json"

Â  Â  Â  Â  Â  if [ ! -f "$STEP_FILE" ]; then
Â  Â  Â  Â  Â  Â  echo "âŒ Fatal Error: STEP file ($STEP_FILE) not found. Cannot run integration test."
Â  Â  Â  Â  Â  Â  exit 1
Â  Â  Â  Â  Â  fi
Â  Â  Â  Â  Â  if [ ! -f "$EXPECTED_OUTPUT_PATH" ]; then
Â  Â  Â  Â  Â  Â  echo "âŒ Fatal Error: Expected Output file ($EXPECTED_OUTPUT_PATH) not found. Cannot run integration test."
Â  Â  Â  Â  Â  Â  exit 1
Â  Â  Â  Â  Â  fi

Â  Â  Â  Â  Â  echo "--- Running test: test_cube (Expected Output: $EXPECTED_OUTPUT_PATH) ---"

Â  Â  Â  Â  Â  RESOLUTION=0.5
Â  Â  Â  Â  Â  FLOW_REGION="internal"

Â  Â  Â  Â  Â  python3 src/gmsh_runner.py \
Â  Â  Â  Â  Â  Â  --step "$STEP_FILE" \
Â  Â  Â  Â  Â  Â  --resolution "$RESOLUTION" \
Â  Â  Â  Â  Â  Â  --flow_region "$FLOW_REGION" \
Â  Â  Â  Â  Â  Â  --output "$TEMP_OUTPUT_FILE"

Â  Â  Â  Â  Â  # compare_json.py exits 1 if files don't match, failing this step.
Â  Â  Â  Â  Â  python3 tests/helpers/compare_json.py "$EXPECTED_OUTPUT_PATH" "$TEMP_OUTPUT_FILE"

Â  Â  Â  Â  Â  echo "âœ… Integration test completed for test_cube."

Â  Â  Â  # ----------------------------------------------------------------------
Â  Â  Â  # Integration Test 2: hollow_cylinder (HARD FAIL on mismatch)
Â  Â  Â  # ----------------------------------------------------------------------
Â  Â  Â  - name: ğŸƒ Run Integration Test (hollow_cylinder)
Â  Â  Â  Â  id: integration_test_cylinder
Â  Â  Â  Â  # Failure here stops the workflow.
Â  Â  Â  Â  run: |
Â  Â  Â  Â  Â  STEP_FILE="tests/test_models/hollow_cylinder.step"
Â  Â  Â  Â  Â  EXPECTED_OUTPUT_PATH="tests/test_models/hollow_cylinder_internal_output.json"
Â  Â  Â  Â  Â  TEMP_OUTPUT_FILE="tests/test_models/hollow_cylinder_cli_output.json"

Â  Â  Â  Â  Â  if [ ! -f "$STEP_FILE" ]; then
Â  Â  Â  Â  Â  Â  echo "âŒ Fatal Error: STEP file ($STEP_FILE) not found. Cannot run integration test."
Â  Â  Â  Â  Â  Â  exit 1
Â  Â  Â  Â  Â  fi
Â  Â  Â  Â  Â  if [ ! -f "$EXPECTED_OUTPUT_PATH" ]; then
Â  Â  Â  Â  Â  Â  echo "âŒ Fatal Error: Expected Output file ($EXPECTED_OUTPUT_PATH) not found. Cannot run integration test."
Â  Â  Â  Â  Â  Â  exit 1
Â  Â  Â  Â  Â  fi

Â  Â  Â  Â  Â  echo "--- Running test: hollow_cylinder (Expected Output: $EXPECTED_OUTPUT_PATH) ---"

Â  Â  Â  Â  Â  RESOLUTION=0.5
Â  Â  Â  Â  Â  FLOW_REGION="internal"

Â  Â  Â  Â  Â  python3 src/gmsh_runner.py \
Â  Â  Â  Â  Â  Â  --step "$STEP_FILE" \
Â  Â  Â  Â  Â  Â  --resolution "$RESOLUTION" \
Â  Â  Â  Â  Â  Â  --flow_region "$FLOW_REGION" \
Â  Â  Â  Â  Â  Â  --output "$TEMP_OUTPUT_FILE"

Â  Â  Â  Â  Â  # compare_json.py exits 1 if files don't match, failing this step.
Â  Â  Â  Â  Â  python3 tests/helpers/compare_json.py "$EXPECTED_OUTPUT_PATH" "$TEMP_OUTPUT_FILE"

Â  Â  Â  Â  Â  echo "âœ… Integration test completed for hollow_cylinder."
Â  Â  Â Â 
Â  Â  Â  # ----------------------------------------------------------------------
Â  Â  Â  # Integration Test 3: cube_with_hole (HARD FAIL on mismatch)
Â  Â  Â  # ----------------------------------------------------------------------
Â  Â  Â  - name: ğŸƒ Run Integration Test (cube_with_hole)
Â  Â  Â  Â  id: integration_test_cube_with_hole
Â  Â  Â  Â  # Failure here stops the workflow.
Â  Â  Â  Â  run: |
Â  Â  Â  Â  Â  STEP_FILE="tests/test_models/cube_with_hole.step"
Â  Â  Â  Â  Â  EXPECTED_OUTPUT_PATH="tests/test_models/cube_with_hole_internal_output.json"
Â  Â  Â  Â  Â  TEMP_OUTPUT_FILE="tests/test_models/cube_with_hole_cli_output.json"

Â  Â  Â  Â  Â  if [ ! -f "$STEP_FILE" ]; then
Â  Â  Â  Â  Â  Â  echo "âŒ Fatal Error: STEP file ($STEP_FILE) not found. Cannot run integration test."
Â  Â  Â  Â  Â  Â  exit 1
Â  Â  Â  Â  Â  fi
Â  Â  Â  Â  Â  if [ ! -f "$EXPECTED_OUTPUT_PATH" ]; then
Â  Â  Â  Â  Â  Â  echo "âŒ Fatal Error: Expected Output file ($EXPECTED_OUTPUT_PATH) not found. Cannot run integration test."
Â  Â  Â  Â  Â  Â  exit 1
Â  Â  Â  Â  Â  fi

Â  Â  Â  Â  Â  echo "--- Running test: cube_with_hole (Expected Output: $EXPECTED_OUTPUT_PATH) ---"

Â  Â  Â  Â  Â  RESOLUTION=0.5
Â  Â  Â  Â  Â  FLOW_REGION="internal"

Â  Â  Â  Â  Â  python3 src/gmsh_runner.py \
Â  Â  Â  Â  Â  Â  --step "$STEP_FILE" \
Â  Â  Â  Â  Â  Â  --resolution "$RESOLUTION" \
Â  Â  Â  Â  Â  Â  --flow_region "$FLOW_REGION" \
Â  Â  Â  Â  Â  Â  --output "$TEMP_OUTPUT_FILE"

Â  Â  Â  Â  Â  # compare_json.py exits 1 if files don't match, failing this step.
Â  Â  Â  Â  Â  python3 tests/helpers/compare_json.py "$EXPECTED_OUTPUT_PATH" "$TEMP_OUTPUT_FILE"

Â  Â  Â  Â  Â  echo "âœ… Integration test completed for cube_with_hole."

Â  Â  Â  - name: â˜ï¸ Download & normalize STEP file
Â  Â  Â  Â  env:
Â  Â  Â  Â  Â  APP_KEY: ${{ secrets.APP_KEY }}
Â  Â  Â  Â  Â  APP_SECRET: ${{ secrets.APP_SECRET }}
Â  Â  Â  Â  Â  REFRESH_TOKEN: ${{ secrets.REFRESH_TOKEN }}
Â  Â  Â  Â  run: |
Â  Â  Â  Â  Â  chmod +x src/download_from_dropbox.sh
Â  Â  Â  Â  Â  src/download_from_dropbox.sh

Â  Â  Â  Â  Â  STEP_FILES=$(find data/testing-input-output -maxdepth 1 -type f -name "*.step")
Â  Â  Â  Â  Â  COUNT=$(echo "$STEP_FILES" | wc -l)
Â  Â  Â  Â  Â  if [ "$COUNT" -eq 0 ]; then
Â  Â  Â  Â  Â  Â  echo "âŒ No STEP file found. Cannot proceed."
Â  Â  Â  Â  Â  Â  exit 1
Â  Â  Â  Â  Â  elif [ "$COUNT" -gt 1 ]; then
Â  Â  Â  Â  Â  Â  echo "âš ï¸ Multiple STEP files found. Normalizing..."
Â  Â  Â  Â  Â  Â  STEP_FILE=$(echo "$STEP_FILES" | head -n 1)
Â  Â  Â  Â  Â  Â  mv "$STEP_FILE" data/testing-input-output/input.step
Â  Â  Â  Â  Â  Â  echo "âœ… Normalized STEP file to input.step."
Â  Â  Â  Â  Â  else
Â  Â  Â  Â  Â  Â  STEP_FILE=$(echo "$STEP_FILES")
Â  Â  Â  Â  Â  Â  if [ "$STEP_FILE" != "data/testing-input-output/input.step" ]; then
Â  Â  Â  Â  Â  Â  Â  mv "$STEP_FILE" data/testing-input-output/input.step
Â  Â  Â  Â  Â  Â  Â  echo "âœ… Renamed $STEP_FILE to input.step"
Â  Â  Â  Â  Â  Â  else
Â  Â  Â  Â  Â  Â  Â  echo "â„¹ï¸ STEP file is already named input.step. No renaming needed."
Â  Â  Â  Â  Â  Â  fi
Â  Â  Â  Â  Â  fi

Â  Â  Â  - name: ğŸ§  Extract config & run Gmsh
Â  Â  Â  Â  run: |
Â  Â  Â  Â  Â  resolution=$(python -c "import json; print(json.load(open('data/testing-input-output/flow_data.json'))['model_properties']['default_resolution'])")
Â  Â  Â  Â  Â  flow_region=$(python -c "import json; print(json.load(open('data/testing-input-output/flow_data.json'))['model_properties']['flow_region'])")

Â  Â  Â  Â  Â  python3 src/gmsh_runner.py \
Â  Â  Â  Â  Â  Â  --step data/testing-input-output/input.step \
Â  Â  Â  Â  Â  Â  --resolution "$resolution" \
Â  Â  Â  Â  Â  Â  --flow_region "$flow_region" \
Â  Â  Â  Â  Â  Â  --output data/testing-input-output/geometry_masking_gmsh.json

Â  Â  Â  - name: ğŸ” Validate output JSON against schema
Â  Â  Â  Â  run: |
Â  Â  Â  Â  Â  python -c "
Â  Â  Â  Â  Â  import json, jsonschema
Â  Â  Â  Â  Â  from pathlib import Path
Â  Â  Â  Â  Â  output_path = Path('data/testing-input-output/geometry_masking_gmsh.json')
Â  Â  Â  Â  Â  if not output_path.exists():
Â  Â  Â  Â  Â  Â  raise FileNotFoundError(f'Schema validation failed â€” file not found: {output_path}')
Â  Â  Â  Â  Â  with open('schemas/domain_schema.json') as s, open(output_path) as d:
Â  Â  Â  Â  Â  Â  schema = json.load(s)
Â  Â  Â  Â  Â  Â  data = json.load(d)
Â  Â  Â  Â  Â  Â  jsonschema.validate(instance=data, schema=schema)
Â  Â  Â  Â  Â  "
Â  Â  Â  Â  Â  echo "âœ… Output schema validated"

Â  Â  Â  - name: ğŸ§ª Run Unit Tests with Coverage
Â  Â  Â  Â  run: |
Â  Â  Â  Â  Â  pytest --cov=src --cov-report=term-missing
Â  Â  Â  Â  Â  echo "âœ… Unit tests and code coverage check completed."

Â  Â  Â  - name: â˜ï¸ Upload outputs to Dropbox
Â  Â  Â  Â  env:
Â  Â  Â  Â  Â  APP_KEY: ${{ secrets.APP_KEY }}
Â  Â  Â  Â  Â  APP_SECRET: ${{ secrets.APP_SECRET }}
Â  Â  Â  Â  Â  REFRESH_TOKEN: ${{ secrets.REFRESH_TOKEN }}
Â  Â  Â  Â  run: |
Â  Â  Â  Â  Â  chmod +x src/upload_to_dropbox.sh
Â  Â  Â  Â  Â  src/upload_to_dropbox.sh

Â  Â  Â  - name: ğŸ“ Log trigger & push
Â  Â  Â  Â  if: always() # Run even if previous steps failed to ensure log and error reports are committed
Â  Â  Â  Â  env:
Â  Â  Â  Â  Â  GIT_USER_NAME: ${{ secrets.GIT_USER_NAME }}
Â  Â  Â  Â  Â  GIT_USER_EMAIL: ${{ secrets.GIT_USER_EMAIL }}
Â  Â  Â  Â  run: |
Â  Â  Â  Â  Â  echo "$(date '+%Y-%m-%d %H:%M:%S'): STEP processor triggered by '${{ github.actor }}' via '${{ github.event_name }}' event" >> trigger.txt
Â  Â  Â  Â  Â  git config --global user.name "${GIT_USER_NAME}"
Â  Â  Â  Â  Â  git config --global user.email "${GIT_USER_EMAIL}"
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  # Commit error reports and trigger log
Â  Â  Â  Â  Â  if [ -d "tests/integration_tests_errors" ]; then
Â  Â  Â  Â  Â  Â  git add --force tests/integration_tests_errors
Â  Â  Â  Â  Â  Â  echo "âš ï¸ Added error reports for commit."
Â  Â  Â  Â  Â  fi
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  git add trigger.txt
Â  Â  Â  Â  Â  git commit -m "Log STEP processor trigger by ${{ github.actor }} via ${{ github.event_name }}" || echo "No new log or errors to commit"
Â  Â  Â  Â  Â  git push
